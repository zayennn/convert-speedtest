<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speedtest Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3B82F6",
              secondary: "#10B981",
              accent: "#F59E0B",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4"
  >
    <div class="container max-w-4xl mx-auto">
      <!-- Judul -->
      <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 mb-8">
        Speedtest Sederhana
      </h1>

      <!-- Container untuk hasil speedtest -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Card Download -->
        <div
          class="bg-white rounded-xl shadow-lg p-6 transition-transform hover:scale-105"
        >
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Download</h2>
          <div class="flex items-end">
            <span id="download-mbps" class="text-4xl font-bold text-primary"
              >0</span
            >
            <span class="text-gray-500 ml-2">Mbps</span>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <span id="download-mbs">0</span> MB/s
          </div>
        </div>

        <!-- Card Upload -->
        <div
          class="bg-white rounded-xl shadow-lg p-6 transition-transform hover:scale-105"
        >
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Upload</h2>
          <div class="flex items-end">
            <span id="upload-mbps" class="text-4xl font-bold text-secondary"
              >0</span
            >
            <span class="text-gray-500 ml-2">Mbps</span>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <span id="upload-mbs">0</span> MB/s
          </div>
        </div>

        <!-- Card Ping -->
        <div
          class="bg-white rounded-xl shadow-lg p-6 transition-transform hover:scale-105"
        >
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Ping</h2>
          <div class="flex items-end">
            <span id="ping-ms" class="text-4xl font-bold text-accent">0</span>
            <span class="text-gray-500 ml-2">ms</span>
          </div>
        </div>
      </div>

      <!-- Tombol Tes Ulang -->
      <div class="text-center">
        <button
          id="retest-btn"
          class="bg-primary hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-colors"
        >
          Tes Ulang
        </button>
      </div>
    </div>

    <script>
      // Fungsi untuk mengonversi Mbps ke MB/s
      function mbpsToMBs(mbps) {
        return (mbps / 8).toFixed(2);
      }

      // Fungsi animasi angka dari 0 ke nilai target
      function animateValue(
        elementId,
        targetValue,
        duration = 2000,
        suffix = ""
      ) {
        const element = document.getElementById(elementId);
        const startValue = 0;
        const increment = targetValue / (duration / 16); // 16ms per frame (≈60fps)
        let currentValue = startValue;

        const timer = setInterval(() => {
          currentValue += increment;
          if (currentValue >= targetValue) {
            clearInterval(timer);
            currentValue = targetValue;
          }
          element.textContent = currentValue.toFixed(2) + suffix;
        }, 16);
      }

      // Fungsi untuk menampilkan data speedtest
      function displaySpeedtestData(data) {
        // Animasikan nilai Mbps
        animateValue("download-mbps", data.download_mbps);
        animateValue("upload-mbps", data.upload_mbps);
        animateValue("ping-ms", data.ping_ms, 1000, ""); // Ping lebih cepat

        // Hitung dan tampilkan nilai MB/s (tanpa animasi untuk menghindari kompleksitas)
        const downloadMBs = mbpsToMBs(data.download_mbps);
        const uploadMBs = mbpsToMBs(data.upload_mbps);

        document.getElementById(
          "download-mbs"
        ).textContent = `≈ ${downloadMBs}`;
        document.getElementById("upload-mbs").textContent = `≈ ${uploadMBs}`;
      }

      // Fungsi untuk memanggil endpoint backend
      async function runSpeedtest() {
        const button = document.getElementById("retest-btn");
        button.disabled = true;
        button.textContent = "Sedang menguji...";

        try {
          const response = await fetch("/speedtest");
          const data = await response.json();

          // Reset nilai sebelum menampilkan yang baru
          document.getElementById("download-mbps").textContent = "0";
          document.getElementById("upload-mbps").textContent = "0";
          document.getElementById("ping-ms").textContent = "0";
          document.getElementById("download-mbs").textContent = "0";
          document.getElementById("upload-mbs").textContent = "0";

          // Tampilkan data baru dengan animasi
          setTimeout(() => {
            displaySpeedtestData(data);
          }, 100);
        } catch (error) {
          console.error("Error:", error);
          alert("Gagal melakukan tes kecepatan. Silakan coba lagi.");
        } finally {
          button.disabled = false;
          button.textContent = "Tes Ulang";
        }
      }

      document
        .getElementById("retest-btn")
        .addEventListener("click", runSpeedtest);

      const sampleData = {
        download_mbps: 45.23,
        upload_mbps: 12.5,
        ping_ms: 22,
      };

      document.addEventListener("DOMContentLoaded", () => {
        displaySpeedtestData(sampleData);
      });
    </script>
  </body>
</html>