<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speedtest Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3B82F6",
              secondary: "#10B981",
              accent: "#F59E0B",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4"
  >
    <div class="container max-w-4xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 mb-2">
        Speedtest Sederhana
      </h1>
      <p class="text-center text-gray-600 mb-8">
        Tes kecepatan internet Anda dengan mudah
      </p>

      <div class="bg-gray-200 rounded-full h-2.5 mb-8 mx-auto max-w-xl">
        <div
          id="test-progress"
          class="test-progress bg-primary rounded-full h-2.5"
          style="width: 0%"
        ></div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2
          id="current-test"
          class="text-2xl font-semibold text-center text-gray-700 mb-6"
        >
          Siap untuk memulai tes
        </h2>

        <div class="gauge-container mb-6">
          <div class="gauge-background"></div>
          <div
            id="needle"
            class="needle"
            style="transform: translateX(-50%) rotate(-90deg)"
          ></div>
          <div class="gauge-center"></div>
        </div>

        <div class="text-center">
          <div id="speed-value" class="text-5xl font-bold text-primary mb-2">
            0
          </div>
          <div id="speed-unit" class="text-xl text-gray-600">Mbps</div>
          <div id="conversion-value" class="mt-4 text-gray-600 hidden"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div
          id="download-card"
          class="bg-gray-100 rounded-xl shadow p-4 opacity-70"
        >
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Download</h2>
          <div class="flex items-end">
            <span id="download-mbps" class="text-3xl font-bold text-primary"
              >-</span
            >
            <span class="text-gray-500 ml-2">Mbps</span>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <span id="download-mbs">-</span> MB/s
          </div>
        </div>
        <div
          id="upload-card"
          class="bg-gray-100 rounded-xl shadow p-4 opacity-70"
        >
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Upload</h2>
          <div class="flex items-end">
            <span id="upload-mbps" class="text-3xl font-bold text-secondary"
              >-</span
            >
            <span class="text-gray-500 ml-2">Mbps</span>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <span id="upload-mbs">-</span> MB/s
          </div>
        </div>
        <div
          id="ping-card"
          class="bg-gray-100 rounded-xl shadow p-4 opacity-70"
        >
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Ping</h2>
          <div class="flex items-end">
            <span id="ping-ms" class="text-3xl font-bold text-accent">-</span>
            <span class="text-gray-500 ml-2">ms</span>
          </div>
        </div>
      </div>

      <div class="text-center">
        <button
          id="start-btn"
          class="bg-primary hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition-colors pulse"
        >
          Mulai Tes
        </button>
        <button
          id="retest-btn"
          class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full transition-colors hidden"
        >
          Tes Ulang
        </button>
      </div>
    </div>

    <script>
      const testStatus = {
        NOT_STARTED: "not_started",
        TESTING_PING: "testing_ping",
        TESTING_DOWNLOAD: "testing_download",
        TESTING_UPLOAD: "testing_upload",
        COMPLETED: "completed",
      };
      let currentStatus = testStatus.NOT_STARTED;

      function mbpsToMBs(mbps) {
        return (mbps / 8).toFixed(2);
      }
      function updateNeedle(value, maxValue, unit) {
        const needle = document.getElementById("needle");
        const degrees = (value / maxValue) * 180 - 90;
        needle.style.transform = `translateX(-50%) rotate(${degrees}deg)`;
        document.getElementById("speed-value").textContent = value.toFixed(2);
        document.getElementById("speed-unit").textContent = unit;
      }
      function updateProgress(percentage) {
        document.getElementById("test-progress").style.width = `${percentage}%`;
      }
      function setTestStatus(status) {
        currentStatus = status;
        switch (status) {
          case testStatus.NOT_STARTED:
            document.getElementById("current-test").textContent =
              "Siap untuk memulai tes";
            updateNeedle(0, 100, "Mbps");
            updateProgress(0);
            break;
          case testStatus.TESTING_PING:
            document.getElementById("current-test").textContent =
              "Sedang mengukur Ping...";
            updateProgress(20);
            break;
          case testStatus.TESTING_DOWNLOAD:
            document.getElementById("current-test").textContent =
              "Sedang mengukur Download...";
            updateProgress(50);
            break;
          case testStatus.TESTING_UPLOAD:
            document.getElementById("current-test").textContent =
              "Sedang mengukur Upload...";
            updateProgress(80);
            break;
          case testStatus.COMPLETED:
            document.getElementById("current-test").textContent =
              "Tes Selesai!";
            updateProgress(100);
            document.getElementById("start-btn").classList.add("hidden");
            document.getElementById("retest-btn").classList.remove("hidden");
            break;
        }
      }
      function animateValue(
        elementId,
        targetValue,
        duration = 2000,
        suffix = "",
        isPing = false
      ) {
        const element = document.getElementById(elementId);
        const startValue = 0;
        const increment = targetValue / (duration / 16);
        let currentValue = startValue;
        const timer = setInterval(() => {
          currentValue += increment;
          if (currentValue >= targetValue) {
            clearInterval(timer);
            currentValue = targetValue;
          }
          element.textContent = isPing
            ? Math.round(currentValue)
            : currentValue.toFixed(2);
          if (suffix) element.textContent += suffix;
        }, 16);
      }

      async function runSpeedtest() {
        document.getElementById("start-btn").disabled = true;
        document.getElementById("start-btn").classList.remove("pulse");
        try {
          setTestStatus(testStatus.TESTING_PING);
          const pingRes = await fetch("/speedtest/ping");
          const pingData = await pingRes.json();
          updateNeedle(pingData.ping_ms, 100, "ms");
          animateValue("ping-ms", pingData.ping_ms, 1000, "", true);

          setTestStatus(testStatus.TESTING_DOWNLOAD);
          const dlRes = await fetch("/speedtest/download");
          const dlData = await dlRes.json();
          updateNeedle(dlData.download_mbps, 100, "Mbps");
          animateValue("download-mbps", dlData.download_mbps);
          document.getElementById("download-mbs").textContent =
            "≈ " + mbpsToMBs(dlData.download_mbps);

          setTestStatus(testStatus.TESTING_UPLOAD);
          const ulRes = await fetch("/speedtest/upload");
          const ulData = await ulRes.json();
          updateNeedle(ulData.upload_mbps, 50, "Mbps");
          animateValue("upload-mbps", ulData.upload_mbps);
          document.getElementById("upload-mbs").textContent =
            "≈ " + mbpsToMBs(ulData.upload_mbps);

          document.getElementById("conversion-value").innerHTML = `
            <div class="fade-in">
              <p><strong>Download:</strong> ${dlData.download_mbps.toFixed(
                2
              )} Mbps ≈ ${mbpsToMBs(dlData.download_mbps)} MB/s</p>
              <p><strong>Upload:</strong> ${ulData.upload_mbps.toFixed(
                2
              )} Mbps ≈ ${mbpsToMBs(ulData.upload_mbps)} MB/s</p>
              <p><strong>Ping:</strong> ${Math.round(pingData.ping_ms)} ms</p>
            </div>`;
          document
            .getElementById("conversion-value")
            .classList.remove("hidden");

          setTestStatus(testStatus.COMPLETED);
        } catch (e) {
          alert("Tes gagal. Coba lagi.");
          setTestStatus(testStatus.NOT_STARTED);
          document.getElementById("start-btn").disabled = false;
          document.getElementById("start-btn").classList.add("pulse");
        }
      }

      document
        .getElementById("start-btn")
        .addEventListener("click", runSpeedtest);
      document.getElementById("retest-btn").addEventListener("click", () => {
        document.getElementById("download-mbps").textContent = "-";
        document.getElementById("upload-mbps").textContent = "-";
        document.getElementById("ping-ms").textContent = "-";
        document.getElementById("download-mbs").textContent = "-";
        document.getElementById("upload-mbs").textContent = "-";
        document.getElementById("conversion-value").classList.add("hidden");
        document.getElementById("retest-btn").classList.add("hidden");
        document.getElementById("start-btn").classList.remove("hidden");
        document.getElementById("start-btn").disabled = false;
        document.getElementById("start-btn").classList.add("pulse");
        setTestStatus(testStatus.NOT_STARTED);
      });
    </script>
  </body>
</html>
